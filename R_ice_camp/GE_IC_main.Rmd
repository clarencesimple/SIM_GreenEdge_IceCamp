---
title: "GE_IC_main"
author: "Clarence W H Sim"
output: pdf_document
---

# Load various R files (Must be in this order)

```{r, echo=FALSE}
#Set working directory using relative file path
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

#Read phyloseq file and R packages
source("../R_ice_camp/GE_IC_read_phyloseq.R")

#Adding sample labels, clusters, ice and water depths, metaPR2 cASVs, biogeography of ASVs, culturability of ASVs,.
source("../R_ice_camp/GE_IC_data_organisation.R") 

#Read color allocation for plots
source("../R_ice_camp/GE_IC_color.R")

#load functions (e.g. treemap, longform, normalize)
source("../R_ice_camp/GE_IC_functions.R")

```

# Retrieve only the time series (TS) samples from the phyloseq file

```{r, message=FALSE }
ps <- ps %>% subset_samples(is.na(experiment_name) & 
                                 (substrate=="water" | substrate=="ice") & 
                                 fraction_name %in% c("pico","nano","micro") &
                                 DNA_RNA=="DNA") %>%
  subset_taxa(!confident_boot %in% c("domain","supergroup")) %>%#more very ambiguous ASVs 
  subset_taxa(!(division %in% c("Rhodophyta","Alveolata","Rhizaria")) &
                !(subdivision %in% c("Metazoa", "Fungi","Rhodophyta","Stramenopiles_X")) & 
                !(class %in% c("Phaeophyceae","Embryophyceae","Opisthokonta_XX")) &
                !(order %in% c("Bryopsidales","Ulotrichales","Dasycladales","Trentepohliales","Cladophorales"))) 

#all taxa
# Do normalizations and transformation
ps_IC <- phyloseq_normalize_median(ps)
long_IC <- phyloseq_transform_to_long(ps) 
long_IC <- filter(long_IC,is.na(fraction_name)=="FALSE") # normalization removed ASVs with very low reads

taxa <- data.frame(tax_table(ps_IC)) %>% rownames_to_column("asv_code") %>% filter(asv_code %in% unique(long_IC$asv_code))
sample <- data.frame(sample_data(ps_IC)) %>% select(sample_name,metadata_code,DNA_RNA,fraction_name,date,depth_level,substrate,bloom_stage)


#photosynthetic taxa only
ps_TS <- ps %>% 
  subset_taxa(trophic_mode %in% c("photosynthetic","mixotrophic"))
# Do normalizations and transformation
ps_TS <- phyloseq_normalize_median(ps_TS)
long <- phyloseq_transform_to_long(ps_TS) 
long <- filter(long,is.na(fraction_name)=="FALSE") # normalization removed ASVs with very low reads

```

# Arranging the water and ice depths, and size fractions

```{r fig.height=10, fig.width=18}
long$fraction_name<-factor(long$fraction_name, levels=c("pico", "nano", "micro"))
long$trophic_mode<-factor(long$trophic_mode, levels=trophicMode)
long$depth_level<-factor(long$depth_level, levels=c("ICE_1","ICE_0", "WATER_1","WATER_2", "WATER_3", "WATER_4"))
long$date <- lubridate::ymd(long$date)
```

# ice and snow plots

```{r fig.height=10, fig.width=18}
ice_thickness <- read_excel("../R_ice_camp/metadata/metadata_icesnow.xlsx", skip=2)
snow <- select(ice_thickness, `Date`:`Snow (cm)`)
snow <- cbind(snow, data.frame(rep("Snow", 30)))
names(snow)[names(snow) == "rep..Snow...30."] <- "type"
names(snow)[names(snow) == "Snow (cm)"] <- "thickness"

ice <- select(ice_thickness,`Date`,`Ice (cm)`)
ice <- cbind(ice, data.frame(rep("Ice", 30)))
names(ice)[names(ice) == "rep..Ice...30."] <- "type"
names(ice)[names(ice) == "Ice (cm)"] <- "thickness"
ice$thickness<-ice$thickness*-1 # make the ice below sea level
ice_snow <- merge(snow,ice, all = TRUE)
names(ice_snow)[names(ice_snow) == "Date"] <- "date"
ice_snow$date <-  lubridate::ymd(ice_snow$date)
ice_snow$type<-factor(ice_snow$type,levels=c("Snow","Ice"))

#adding ice sampling depth as points

ice_samples<-subset(ice_snow, ice_snow$type=="Ice" & as.character(ice_snow$date) %in% c("2016-05-09","2016-05-23","2016-05-30","2016-06-06","2016-06-13","2016-06-20","2016-06-27"))
ice_samples$depth_level<-"ICE_0"
ice_samples2<-ice_samples
ice_samples2$thickness<-ice_samples2$thickness + 10
ice_samples2$depth_level<-"ICE_1"
ice_samples<-rbind(ice_samples,ice_samples2)
 

plot_ice_snow <- ggplot(ice_snow, aes(x = date, y = thickness, fill=type)) + 
  geom_area() +
  geom_vline(xintercept = as.numeric(as.Date("2016-06-03")), linetype = "dashed", size=1, alpha=0.5) +
  geom_vline(xintercept = as.numeric(as.Date("2016-06-15")), linetype = "dashed", size=1, alpha=0.5) +
  scale_fill_manual(values = c("Snow" = "#1261A0", "Ice" = "#58cced")) + 
  xlab("Date") +
  ylab("Thickness (cm)") +
  theme_bw() + 
  labs(group = "type", fill = "type", col = "type")+
  theme(axis.text=element_text(size=22),
        axis.title=element_text(size=22),
        legend.text = element_text(size=24),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) + 
        scale_x_date(limits=c(as.Date("2016-05-01"),as.Date("2016-07-25"))) + 
  theme(legend.title = element_blank(), legend.position = c(0.90, 0.50),  
        legend.background = element_rect(fill = NA),
        legend.key = element_rect(fill = NA),
        panel.grid = element_blank()) +
  geom_point(data=ice_samples, aes(x=date,y=thickness),size=4, color="black",show.legend = FALSE) + 
  geom_line(data=ice_samples, aes(group=depth_level),color="black") +
  geom_dl(data=ice_samples,aes(label = depth_level), method = list(dl.trans(x = x + 1), dl.combine("last.points"),cex=1.5))

#plot_ice_snow

#plot the sampling depths across time

depth_plot<-long%>%group_by(date,substrate,depth,depth_level)%>%summarize(n_reads=sum(n_reads))
depth_plot$date <- lubridate::ymd(depth_plot$date)

plot_depth <- ggplot(depth_plot,aes(x=date, y=depth)) + 
  #rect1 + rect2 + rect3 +
  geom_vline(xintercept = as.numeric(as.Date("2016-06-03")), linetype = "dashed", size=1, alpha=0.5) +
  geom_vline(xintercept = as.numeric(as.Date("2016-06-15")), linetype = "dashed", size=1, alpha=0.5) +
  geom_point(size=4,shape="triangle") + 
  theme_bw() + 
  geom_line(aes(group=depth_level)) +
  theme(axis.text=element_text(size=22),
        axis.text.x=element_text(angle = 45, hjust = 1),
        axis.title=element_text(size=22),
        axis.title.x=element_blank(),
        panel.grid = element_blank()) + 
  scale_y_reverse() + 
  ylab("Water Depth (m)") + 
  scale_x_date(breaks=depth_plot$date,limits=c(as.Date("2016-05-01"),as.Date("2016-07-25")), date_labels = "%B %d") + 
  geom_dl(aes(label = depth_level), method = list(dl.trans(x = x + 1), dl.combine("last.points"),cex=1.5))
  
plot_depth 

```

#plot underwater PAR

```{r fig.height=6, fig.width=10}
depth_sampled <-  c(1.5, 5, 10, 20, 30, 40, 60)
ge_par_all <- read_csv("../R_ice_camp/metadata/metadata_PAR.csv.gz")
ge_par <- filter(ge_par_all, depth_edz_m %in% 2 & year_utc=="2016")
ge_par <- subset(ge_par,is.na(ge_par$par_d_fit_daily_ein_m_2_day_1)==FALSE)

ge_par_mean <- ge_par %>% group_by(year_utc, month_utc, day_utc, depth_edz_m ) %>%  
  dplyr::summarise(par_daily_mean = mean(par_d_fit_daily_ein_m_2_day_1)) %>%  
  dplyr::mutate(date = make_date(year_utc, month_utc, day_utc), depth_m = depth_edz_m, depth_m_char = as.character(depth_edz_m))

ge_par_mean$julian_day <- yday(as.POSIXlt(ge_par_mean$date, format="%d%b%y")) 
ge_par_mean <- select(ungroup(ge_par_mean), date, julian_day, depth_m, par_daily_mean, year_utc)
ge_par_mean_2016 <- filter(ge_par_mean, year_utc == 2016)
ge_par_mean_2016$year_utc <- factor(ge_par_mean_2016$year_utc)

par_plot <- ggplot(ge_par_mean_2016, aes(x = date, y = par_daily_mean)) + 
  geom_vline(xintercept = as.numeric(as.Date("2016-06-03")), linetype = "dashed", size=1, alpha=0.5) +
  geom_vline(xintercept = as.numeric(as.Date("2016-06-15")), linetype = "dashed", size=1, alpha=0.5) +
  geom_line() +
  geom_point(size=3) + 
  ylab(bquote("PAR ("*mol~m^{-2}~d^{-1}*")")) +
  theme_bw()+ 
  labs(group = "Year", fill = "Year", col = "Year") +
  theme(axis.text=element_text(size=22),
        axis.title=element_text(size=22),
        legend.title =element_text(size=22,face="bold"),
        legend.text = element_text(size=22),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        panel.grid = element_blank()) + 
  scale_x_date(limits=c(as.Date("2016-05-01"),as.Date("2016-07-25"))) + 
  scale_y_continuous(breaks = seq(0, 12.5, by = 2.5), limits = c(0,12.5))

par_plot

```

#CHLA pigments

```{r fig.height=10, fig.width=18}

chla_pigments<-read.csv("../R_ice_camp/metadata/metadata_chla_pigments.csv") %>% 
  filter(str_detect(mission, "ice_camp")) %>% 
  filter(sample_type %in% c("water", "ice")) %>% 
  filter(pigment == "Chlorophyll a") %>% 
  filter(sample_source != "underice") %>% 
  filter(method == "HPLC") %>%
  filter(mission == "ice_camp_2016")

# Water Pigment
chla_water_m2 <- chla_pigments %>% 
  filter(sample_type == "water") %>% 
  filter(depth_m <= 60) %>% # Should we use 40m?
  drop_na(conc_mg_m3) %>% 
  group_by(mission, date) %>% 
  mutate(n = n()) %>% 
  filter(n >= 3)

chla_water_m2 <- chla_water_m2 %>% 
  arrange(depth_m) %>% 
  group_by(mission, date, sample_type) %>% 
  nest() %>% 
  mutate(tchla_mg_m2 = map_dbl(data, ~pracma::trapz(.$depth_m, .$conc_mg_m3))) %>% # 1 ug L == 1 mg m-3
  select(-data) 

# Ice Pigment
chla_ice_m2 <- chla_pigments %>%
  filter(sample_type == "ice") %>% 
  filter(sample_source %in% c("0-3 cm", "3-10 cm")) %>% 
  group_by(mission, sample_type, date, sample_source) %>% 
  summarise(conc_mg_m2 = mean(conc_mg_m2)) %>% 
  group_by(mission, date) %>% 
  mutate(n = n()) %>% 
  filter(n == 2) %>% 
  group_by(mission, date, sample_type) %>% 
  summarise(tchla_mg_m2 = sum(conc_mg_m2))

chla_m2 <- bind_rows(chla_ice_m2, chla_water_m2)
chla_m2$date <- lubridate::ymd(chla_m2$date)

chla_plot_massicotte <- ggplot(chla_m2,aes(x = date, y = tchla_mg_m2, color=sample_type)) +
  geom_vline(xintercept = as.numeric(as.Date("2016-06-03")), linetype = "dashed", size=1, alpha=0.5) +
  geom_vline(xintercept = as.numeric(as.Date("2016-06-15")), linetype = "dashed", size=1, alpha=0.5) +
  geom_line(data=chla_m2,show.legend = FALSE,size = 1) +
  geom_point(data=chla_m2,show.legend = FALSE, size = 3) +
  scale_y_log10() +
  annotation_logticks(sides = "l") +
  xlab(NULL) +
  ylab(bquote("Chl a ("*mg~m^{-2}*")")) +
  theme_bw() + 
  theme(axis.text=element_text(size=22),
        axis.title=element_text(size=22,face="bold"),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        panel.grid = element_blank()) + 
  scale_color_manual(values = c("ice" = "#1261A0", "water" = "#48aaad")) +
  scale_x_date(limits=c(as.Date("2016-05-01"),as.Date("2016-07-25"))) + 
  geom_dl(aes(label = sample_type), method = list(dl.trans(x = x + 0.5), dl.combine("last.points"),cex=2))

chla_plot_massicotte

```

#Flow cyto pico nano

```{r fig.height=10, fig.width=18}
  
## Plotting under-ice Pico

fcm <- read_excel("../R_ice_camp/metadata/metadata_cytometry.xlsx", sheet="All data")%>% 
  filter(year=="2016") %>%
  filter(sample_type %in% c("ice","water")) %>%
  filter(depth_level!="underice") %>% 
  filter(sample_code<=6 | sample_code%in%c("IC3","IC4")) #only take those involved in metabarcoding
  
fcm_pico <- fcm %>% 
  group_by(date, sample_type) %>%  
  summarise(pico_ml_mean = mean(Pico_mL)) 

fcm_nano <- fcm %>% 
  group_by(date, sample_type) %>% 
  summarise(nano_ml_mean = mean(Nano_mL))

fcm <- left_join(fcm_pico,fcm_nano,by=c("date","sample_type"))
fcm$pico_nano_ml <- fcm$pico_ml_mean + fcm$nano_ml_mean

fcm$date <-  lubridate::ymd(fcm$date)

fcm_plot <- ggplot(fcm,aes(x = date, y = pico_nano_ml, color=sample_type)) +
  geom_vline(xintercept = as.numeric(as.Date("2016-06-03")), linetype = "dashed", size=1, alpha=0.5) +
  geom_vline(xintercept = as.numeric(as.Date("2016-06-15")), linetype = "dashed",  size=1, alpha=0.5) +
  geom_line(data=fcm,show.legend = FALSE,size = 1) +
  geom_point(data=fcm,show.legend = FALSE, size = 3) +
  scale_y_log10() +
  annotation_logticks(sides = "l") +
  xlab(NULL) +
  ylab("Pico-Nano FCM (cells/mL)") +
  theme_bw() + 
  theme(axis.text=element_text(size=22),
        axis.title=element_text(size=22),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        panel.grid = element_blank()) + 
  scale_color_manual(values = c("ice" = "#1261A0", "water" = "#48aaad")) +
  scale_x_date(limits=c(as.Date("2016-05-01"),as.Date("2016-07-25"))) + 
  geom_dl(aes(label = sample_type), method = list(dl.trans(x = x + 0.5), dl.combine("last.points"),cex=2))

fcm_plot
```

# All together

```{r fig.height=10, fig.width=18}
pdf("../main_figures/environmental_parameters.pdf", height=20, width=22); plot(par_plot/chla_plot_massicotte/fcm_plot/plot_ice_snow/plot_depth); dev.off() 
```

#change back to categorical for plotting

```{r fig.height=10, fig.width=18}
sampling_dates<-c("2016-05-09","2016-05-23","2016-05-30","2016-06-06","2016-06-13","2016-06-20","2016-06-27","2016-07-06","2016-07-18")
sampling_dates_plot<-c("May 09","May 23","May 30","Jun 06","Jun 13","Jun 20","Jun 27","Jul 06","Jul 18")

long$date <- factor(long$date, levels=sampling_dates)

long$date<-str_replace(long$date,"2016-05-","May ")
long$date<-str_replace(long$date,"2016-06-","Jun ")
long$date<-str_replace(long$date,"2016-07-","Jul ")
long$date <- factor(long$date, levels=sampling_dates_plot)
```

# Ordination Plot to check for clustering of samples

```{r fig.height=8, fig.width=14}

ord_DNA <- ordinate(ps_TS, "NMDS", "bray")

p_nmds <- plot_ordination(ps_TS, ord_DNA, type="sample", color="cluster", shape="fraction_name") + 
  geom_point(size=6) + 
  theme(text = element_text(size = 20)) + 
  scale_color_manual(values=nmdsPalette, name="Substrate-stage") +
  theme_bw() +
  annotate("text", x=1.2, y=1.5, label=str_c("Stress = ",round(ord_DNA$stress,4)),size=8) +
  theme(axis.text=element_text(size=22),
        axis.title=element_text(size=22,face="bold"),
        legend.text = element_text(size=22),
        legend.title = element_text(size=22))
p_nmds


cluster = get_variable(ps_TS, "fraction_name")
cluster_ano = anosim(phyloseq::distance(ps_TS,"bray"),cluster)
print(str_c("ANOSIM size fraction | R = ",round(cluster_ano$statistic,4)," | p = ",cluster_ano$signif))

cluster = get_variable(ps_TS, "substrate")
cluster_ano = anosim(phyloseq::distance(ps_TS,"bray"),cluster)
print(str_c("ANOSIM substrate | R = ",round(cluster_ano$statistic,4)," | p = ",cluster_ano$signif))

ps_TS_ice<-subset_samples(ps_TS, substrate=="ice")
cluster = get_variable(ps_TS_ice, "bloom_stage")
cluster_ano = anosim(phyloseq::distance(ps_TS_ice,"bray"),cluster)
print(str_c("ANOSIM Ice Bloom_stage | R = ",round(cluster_ano$statistic,4)," | p = ",cluster_ano$signif))
cluster = get_variable(ps_TS_ice, "fraction_name")
cluster_ano = anosim(phyloseq::distance(ps_TS_ice,"bray"),cluster)
print(str_c("ANOSIM Ice size fraction | R = ",round(cluster_ano$statistic,4)," | p = ",cluster_ano$signif))

ps_TS_water<-subset_samples(ps_TS, substrate=="water")
cluster = get_variable(ps_TS_water, "bloom_stage")
cluster_ano = anosim(phyloseq::distance(ps_TS_water,"bray"),cluster)
print(str_c("ANOSIM Water Bloom_stage | R = ",round(cluster_ano$statistic,4)," | p = ",cluster_ano$signif))
cluster = get_variable(ps_TS_water, "fraction_name")
cluster_ano = anosim(phyloseq::distance(ps_TS_water,"bray"),cluster)
print(str_c("ANOSIM Water size fraction | R = ",round(cluster_ano$statistic,4)," | p = ",cluster_ano$signif))

pdf("../main_figures/nmds.pdf", height=12, width=20); plot(p_nmds); dev.off() 

```

# Plot Main trophic mode across all ice and water using long_IC (includes all non-photosynthetic taxa)

```{r fig.height=10, fig.width=16}

long_IC$fraction_name<-factor(long_IC$fraction_name, levels=c("pico", "nano", "micro"))
long_IC<- long_IC %>% filter(is.na(fraction_name)=="FALSE" )
long_IC$trophic_mode<-factor(long_IC$trophic_mode, levels=trophicMode)
long_IC$depth_level<-factor(long_IC$depth_level, levels=c("ICE_1","ICE_0", "WATER_1","WATER_2", "WATER_3", "WATER_4"))


long_IC$date<-str_replace(long_IC$date,"2016-05-","May ")
long_IC$date<-str_replace(long_IC$date,"2016-06-","Jun ")
long_IC$date<-str_replace(long_IC$date,"2016-07-","Jul ")
long_IC$date <- factor(long_IC$date, levels=sampling_dates_plot)

long_IC_trophic <- long_IC %>% group_by(fraction_name,depth_level,date,trophic_mode) %>% summarize(n_reads=sum(n_reads))
  
p_trophic <- ggplot(long_IC_trophic, aes(x=date, y=n_reads, fill=trophic_mode)) + 
  geom_bar(position="fill", stat="identity", color="black",size=0.3) + 
  theme_bw() +
  theme(text=element_text(size=26),
        axis.text.x = element_text(angle = 45,  hjust=1),
        axis.title.x=element_blank(),
        legend.title=element_blank(),
        panel.spacing.x=unit(2, "lines"),
        panel.spacing.y=unit(1, "lines"), 
        plot.margin = unit(c(0,0,3,0), "cm"),
        panel.grid=element_blank(),
        strip.background=element_blank(),
        legend.key.size=unit(2,"line")) +
  ylab("Proportion of DNA reads") +
  scale_y_continuous(labels=scales::percent, breaks = seq(0,1, by=0.5)) +
  facet_grid(cols = vars(fraction_name), rows=vars(depth_level), scales="free_x") + 
  scale_fill_manual(values=trophicPalette, 
                    breaks=trophicMode) 
p_trophic 

pdf("../supplementary_figures/supplementary_trophic_overall.pdf", height=16, width=20); plot(p_trophic); dev.off() 

#proportion of protists that are photo and mixo
photo_sum <- long_IC_trophic %>% filter(trophic_mode=="photosynthetic")
sum(photo_sum$n_reads)/sum(long_IC_trophic$n_reads)*100
mixo_sum <- long_IC_trophic %>% filter(trophic_mode=="mixotrophic")
sum(mixo_sum$n_reads)/sum(long_IC_trophic$n_reads)*100

```

# Plot Biogeo across all samples

```{r fig.height=10, fig.width=16}

long_biogeo <- long %>% 
  group_by(fraction_name,depth_level,date,biogeo) %>% 
  summarize(n_reads=sum(n_reads))

long_biogeo$date <- factor(long_biogeo$date, levels=sampling_dates_plot)

unique(long_biogeo$biogeo)

long_biogeo$biogeo<-factor(long_biogeo$biogeo, levels=biogeoLevels)

unallocated<-long_biogeo %>% filter(biogeo=="Unallocated") 
sum(unallocated$n_reads)/sum(long_biogeo$n_reads)

p_biogeo <- ggplot(long_biogeo, aes(x=date, y=n_reads, fill=biogeo)) + 
  geom_bar(position="fill", stat="identity",color="black",size=0.3) + 
  theme_bw() +
  theme(text=element_text(size=24),
        axis.text.x = element_text(angle = 45,  hjust=1),
        axis.title.x=element_blank(),
        legend.title=element_blank(),
        panel.spacing.x=unit(2, "lines"),
        panel.spacing.y=unit(1, "lines"), 
        plot.margin = unit(c(0,0,3,0), "cm"),
        panel.grid=element_blank(),
        strip.background=element_blank(),
        legend.key.size=unit(2,"line")) +
  ylab("Proportion of DNA reads") + 
  scale_y_continuous(labels=scales::percent, breaks = seq(0,1, by=0.5)) +
  facet_grid(cols = vars(fraction_name), rows=vars(depth_level), scales="free_x") + 
  scale_fill_manual(values=biogeoPalette, 
                    breaks = biogeoLevels)
p_biogeo 

pdf("../supplementary_figures/supplementary_biogeo_photosynthetic.pdf", height=16, width=20); plot(p_biogeo); dev.off() 
```

# Make table of photosynthetic ASV properties and assignment

```{r}
ASVs <- (unique(long$asv_code))
taxa_DNA <- taxa %>%
  filter(asv_code%in%ASVs) %>%
  filter(trophic_mode %in% c("photosynthetic","mixotrophic"))
```

# Tree map

```{r fig.height=6, fig.width=6}
long_phyto_ice<-subset(long,substrate=="ice")
long_phyto_water<-subset(long,substrate=="water")

tree_phyto_ice <- phyloseq_long_treemap(long_phyto_ice,division,class,"A) Ice community")
tree_phyto_water <- phyloseq_long_treemap(long_phyto_water,division,class,"B) Water community")

pdf("../supplementary_figures/community.pdf", height=10, width=18); plot(tree_phyto_ice+tree_phyto_water); dev.off() 
```


# Indicator ASV between substrates
# results saved in GE_IC_indicspecies.xlsx

```{r fig.height=6, fig.width=16}

#wide_photosynthetic <- long %>% 
#pivot_wider(id_cols=c(sample_name,substrate),names_from=asv_code, values_from=n_reads,values_fill=0)
#abund<-wide_photosynthetic[,-c(1:2)]
#substrate<-wide_photosynthetic$substrate
#inv <- multipatt(abund, substrate, func="IndVal.g",control=how(nperm=9999))
#summary(inv, indvalcomp = TRUE)
#options(max.print=1000)
#The above data was manually converted into csv and excel

```

# Indicator ASV between stage clusters
# results saved in GE_IC_indicspecies.xlsx

```{r fig.height=6, fig.width=16}

#wide_photosynthetic <- long %>% pivot_wider(id_cols=c(sample_name,bloom_cluster),names_from=asv_code, values_from=n_reads,values_fill=0)
#abund<-wide_photosynthetic[,-c(1:2)]
#stage<-wide_photosynthetic$bloom_cluster
#inv <- multipatt(abund, stage, func="IndVal.g",control=how(nperm=9999))
#summary(inv, indvalcomp = TRUE)
#The above data was manually converted into csv and excel

```


# Indicator Species (substrate) and biogeo

```{r fig.height=16, fig.width=16}

# PCH allocation for biogeo
biogeoShapes<-c(15,17,16,18,8,9,10,4,3)
names(biogeoShapes)<-c("Polar","Polar-Temperate","Polar-Tropical","Temperate","Temperate-Tropical","Tropical","Cosmopolitan","Unallocated","NA")

indic_substrate <- read_excel("../supplementary_tables/GE_IC_indicspecies.xlsx", sheet="substrate")

indic_phyto_ice <- long_phyto_ice %>%
  group_by(asv_code) %>%
  summarize(total_reads=sum(n_reads)) %>% 
  arrange(desc(total_reads))
indic_phyto_ice <- left_join(indic_phyto_ice, taxa, by="asv_code")
indic_phyto_ice$substrate <- "ice"
indic_phyto_ice <- left_join(indic_phyto_ice, indic_substrate, by=c("asv_code","substrate"))


indic_phyto_water <- long_phyto_water %>%
  group_by(asv_code) %>%
  summarize(total_reads=sum(n_reads)) %>% 
  arrange(desc(total_reads))
indic_phyto_water <- left_join(indic_phyto_water, taxa, by="asv_code")
indic_phyto_water$substrate <- "water"
indic_phyto_water <- left_join(indic_phyto_water, indic_substrate, by=c("asv_code","substrate"))

indic_substrate_top<-rbind(indic_phyto_ice[1:20,],indic_phyto_water[1:20,])
# How much of the reads do the top 20 ASVs represent in their respective groupings
sum(indic_phyto_ice$total_reads[1:20])/sum(indic_phyto_ice$total_reads)
sum(indic_phyto_water$total_reads[1:20])/sum(indic_phyto_water$total_reads)

indic_substrate_top$species<-gsub("_"," ",indic_substrate_top$species)

indic_substrate_plot <- lollipop_chart(indic_substrate_top,asv_code,total_reads,facet=substrate, color=division, pch=biogeo,line_size=0.5, point_size=7) +
  theme_bw() +
  theme(text=element_text(size=24),
        axis.text.x = element_text(angle = 0, hjust = 1), 
        axis.text.y = element_text(size=20,family="Courier", face = ifelse(as.numeric(indic_substrate_top$PR2_matches)>0, "bold", "plain")),
        axis.title = element_blank(),
        legend.position="top",
        legend.spacing.y=unit(2,"lines"),
        legend.key.size = unit(2,"lines"),
        legend.text = element_text(margin = margin(r=1,unit="cm")),
        panel.grid=element_blank(),
        panel.spacing.x=unit(2, "lines"),
        strip.background=element_blank(),
        panel.background = element_rect(fill="white")) +
  scale_y_log10(limits=c(1e3,3162277), expand = c(0, 0), breaks = scales::trans_breaks("log10", function(x) 10^x),labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  geom_text(aes(x=asv_code,y=total_reads,label=species),size=8,hjust=0, nudge_y=0.07,show.legend = FALSE,fontface="italic",family="Helvetica") +
  geom_text(aes(x=asv_code,y=total_reads,label=sig),size=8,vjust=-0.4,show.legend = FALSE) +
  guides(color=guide_legend(ncol=1, title.position = "top"), shape=guide_legend(ncol=1,title.position="top")) +
  scale_color_manual(values=treePalette, name="Division") +
  scale_shape_manual(values=biogeoShapes, name="Biogeographic Distribution", breaks=c("Polar","Polar-Temperate","Cosmopolitan","Unallocated"))

indic_substrate_plot

pdf("../main_figures/indicatorASV_substrate.pdf", height=20, width=24); plot(indic_substrate_plot); dev.off() 
```

# Indicator Species (bloom_cluster) and biogeo

```{r fig.height=16, fig.width=16}
indic_bloom_cluster <- read_excel("../supplementary_tables/GE_IC_indicspecies.xlsx", sheet="bloom_cluster")

long_phyto_Stage_I <- subset(long,bloom_cluster=="Stage_I")
long_phyto_Stages_II_and_III <- subset(long,bloom_cluster=="Stages_II_and_III")

indic_phyto_Stage_I <- long_phyto_Stage_I %>%
  group_by(asv_code) %>%
  summarize(total_reads=sum(n_reads)) %>% 
  arrange(desc(total_reads))
indic_phyto_Stage_I <- left_join(indic_phyto_Stage_I, taxa, by="asv_code")
indic_phyto_Stage_I$bloom_cluster <- "Stage_I"
indic_phyto_Stage_I <- left_join(indic_phyto_Stage_I, indic_bloom_cluster, by=c("asv_code","bloom_cluster"))

indic_phyto_Stages_II_and_III <- long_phyto_Stages_II_and_III %>%
  group_by(asv_code) %>%
  summarize(total_reads=sum(n_reads)) %>% 
  arrange(desc(total_reads))
indic_phyto_Stages_II_and_III <- left_join(indic_phyto_Stages_II_and_III, taxa, by="asv_code")
indic_phyto_Stages_II_and_III$bloom_cluster <- "Stages_II_and_III"
indic_phyto_Stages_II_and_III <- left_join(indic_phyto_Stages_II_and_III, indic_bloom_cluster, by=c("asv_code","bloom_cluster"))

indic_bloom_cluster_top<-rbind(indic_phyto_Stage_I[1:20,],indic_phyto_Stages_II_and_III[1:20,])
# How much of the reads do the top 20 ASVs represent in their respective groupings
sum(indic_phyto_Stage_I$total_reads[1:20])/sum(indic_phyto_ice$total_reads)
sum(indic_phyto_Stages_II_and_III$total_reads[1:20])/sum(indic_phyto_water$total_reads)

indic_bloom_cluster_top$species<-gsub("_"," ",indic_bloom_cluster_top$species)

indic_bloom_cluster_plot<-lollipop_chart(indic_bloom_cluster_top,asv_code,total_reads,facet=bloom_cluster, color=division, pch=biogeo,line_size=0.5, point_size=7) +
  theme_bw() +
  ylab("Total number of DNA reads") +
  theme(text=element_text(size=24),
        axis.text.x = element_text(angle = 0, hjust = 1), 
        axis.text.y = element_text(size=20,family="Courier", face = ifelse(as.numeric(indic_substrate_top$PR2_matches)>0, "bold", "plain")),
        axis.title.y = element_blank(),
        legend.position="top",
        legend.spacing.y=unit(2,"lines"),
        legend.key.size = unit(2,"lines"),
        legend.text = element_text(margin = margin(r=1,unit="cm")),
        panel.grid=element_blank(),
        panel.spacing.x=unit(2, "lines"),
        strip.background=element_blank(),
        panel.background = element_rect(fill="white")) +
  scale_y_log10(limits=c(1e3,3162277), expand = c(0, 0), breaks = scales::trans_breaks("log10", function(x) 10^x),labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  geom_text(aes(x=asv_code,y=total_reads,label=species),size=8,hjust=0, nudge_y=0.07,show.legend = FALSE,fontface="italic",family="Helvetica") +
  geom_text(aes(x=asv_code,y=total_reads,label=sig),size=8,vjust=-0.4,show.legend = FALSE) +
  guides(color=guide_legend(ncol=1, title.position = "top"), shape=guide_legend(ncol=1,title.position="top")) +
  scale_color_manual(values=treePalette, name="Division") +
  scale_shape_manual(values=biogeoShapes, name="Biogeographic Distribution", breaks=c("Polar","Polar-Temperate","Cosmopolitan","Unallocated"))

indic_bloom_cluster_plot

pdf("../main_figures/indicatorASV_bloom_cluster.pdf", height=20, width=24); plot(indic_bloom_cluster_plot); dev.off() 

```

# Analysing photosynthetic at Species Level

```{r fig.height=16, fig.width=16}

phyto_species_rank <-long %>%
  group_by(species) %>% 
  summarize(n_reads=sum(n_reads)) %>% 
  arrange(desc(n_reads)) 

sum(phyto_species_rank$n_reads[1:20])/sum(phyto_species_rank$n_reads)
top_phyto_species <- phyto_species_rank$species[1:20]

#normalise entire study's top20 photosynthetic species again
ps_photo_plot <- ps %>% 
  subset_taxa(trophic_mode %in% c("photosynthetic","mixotrophic")) %>%
  subset_taxa(species %in% top_phyto_species)

ps_photo_plot <- phyloseq_normalize_median(ps_photo_plot)
ps_photo_plot <- phyloseq_transform_to_long(ps_photo_plot) 
ps_photo_plot <- filter(ps_photo_plot,is.na(fraction_name)=="FALSE") # normalization removed ASVs with very low reads

normalised_reads <- round(sum(ps_photo_plot$n_reads)/length(unique(ps_photo_plot$sample_name)))

plot_phyto <- ps_photo_plot %>% 
  group_by(sample_name,species,date,depth_level,fraction_name) %>% 
  summarize(n_reads=sum(n_reads))

label <- phyto_colors %>% select(species, label)

#to create labels to label species that has at least 20% of reads
labels <- plot_phyto %>% 
  filter(n_reads>=0.10*normalised_reads) %>% 
  left_join(label,by="species") %>%
  select(sample_name,species,date,depth_level,fraction_name,label)

plot_phyto <- plot_phyto %>% 
  group_by(sample_name,species,date,depth_level,fraction_name) %>% 
  summarize(n_reads=sum(n_reads))

plot_phyto <- left_join(plot_phyto,labels,by=c("sample_name","species","date","depth_level","fraction_name"))

#black and white labels generated separately
plot_phyto$label_white <- ifelse(plot_phyto$label %in% c("Cr","Pp","P1","P2","P3","P4","C4","C5","C6"), plot_phyto$label, NA)
plot_phyto$label_black <- ifelse(plot_phyto$label %in% c("Mp","Bf","Pa","P5","P6","P7","P8","P9","C1","C2","C3"), plot_phyto$label, NA)

#reorganising the data to plot nicely
plot_phyto$species <- factor(plot_phyto$species,levels=phyto_colors$species)
plot_phyto$fraction_name<-factor(plot_phyto$fraction_name, levels=c("pico", "nano", "micro"))
plot_phyto$depth_level<-factor(plot_phyto$depth_level, levels=c("ICE_1","ICE_0", "WATER_1","WATER_2", "WATER_3", "WATER_4"))
plot_phyto$date<-str_replace(plot_phyto$date,"2016-05-","May ")
plot_phyto$date<-str_replace(plot_phyto$date,"2016-06-","Jun ")
plot_phyto$date<-str_replace(plot_phyto$date,"2016-07-","Jul ")
plot_phyto$date <- factor(plot_phyto$date, levels=sampling_dates_plot)

  
p_species <- ggplot(plot_phyto, aes(x=date, y=n_reads,fill=species)) + 
        geom_bar(position="fill", stat="identity",color="black",size=0.5) + theme_bw()+
        theme(text=element_text(size=20),
              axis.text.x = element_text(angle = 45, hjust = 1), 
              legend.justification = "top", 
              legend.spacing.y=unit(1,'cm'), 
              panel.background = element_rect(fill="white"),
              panel.spacing.x=unit(2, "lines"),
              panel.spacing.y=unit(1, "lines"), 
              plot.margin = unit(c(0,0,3,0), "cm"),
              panel.grid = element_blank(),
              strip.background=element_blank(),
              legend.text = element_text(face="italic"),
              legend.key.size=unit(2,"line")) + 
        guides(fill=guide_legend(ncol=1)) +
        ylab("Proportion of reads") +
        geom_text(aes(x=date,y=n_reads,label=label_black,vjust=0.5),
                  position=position_fill(vjust=0.5),
                  size=3, 
                  show.legend = FALSE, 
                  family="Helvetica",
                  color="black") +
        geom_text(aes(x=date,y=n_reads,label=label_white,vjust=0.5),
                  position=position_fill(vjust=0.5),
                  size=3, 
                  show.legend = FALSE, 
                  family="Helvetica",
                  color="white") +
        scale_y_continuous(labels=scales::percent, breaks = seq(0,1, by=0.5)) +
        scale_color_manual(values=phytoPalette) + scale_fill_manual(values=phytoPalette) +
        facet_grid(cols = vars(fraction_name), rows=vars(depth_level), scales="free_x")

p_species
pdf("../main_figures/phyto_species.pdf", height=20, width=18) ; plot(p_species) ; dev.off() 
```

# Culturability of ASVs

```{r fig.height=5, fig.width=8}

asv_blast_div <- taxa_DNA %>%
  filter(as.numeric(PR2_matches)>0) %>%
  group_by(division) %>%
  count() %>%
  summarise(n) %>%
  rename(PR2_matches=n)

asv_div<- taxa_DNA %>% 
  group_by(division) %>%
  count() %>%
  summarise(n) %>%
  arrange(desc(n))

culture <- left_join(asv_div,asv_blast_div,by="division") %>%
  replace(is.na(.), 0) %>%
  mutate(no_matches=n-PR2_matches) %>%
  pivot_longer(cols=c("PR2_matches","no_matches"),names_to="matches",values_to="count") %>%
  mutate(division=str_c(division,"\n (N = ",n,")"))

culture_plot <- ggplot(culture,aes(x=count,y=reorder(division,(n)),fill=matches)) +
  geom_bar(position="fill",stat="identity",width=0.8,color="black") +
  theme_bw() +
  theme(text=element_text(size=18),
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        legend.spacing.y=unit(1,'cm'), 
        panel.background = element_rect(fill="white"),
        panel.grid = element_blank()) + 
  scale_x_continuous(labels=scales::percent, breaks = seq(0,1, by=0.25)) +
  scale_fill_manual(values=c("#0072B2","#BBBBBB"),breaks=c("PR2_matches","no_matches"))
culture_plot

pdf("../supplementary_figures/supplementary_culturability.pdf", height=7, width=14) ; plot(culture_plot) ; dev.off() 
```

# Creating supplementary OTU, Sample, Taxonomy tables, and biogeographical assignment for Photosynthetic ASVs

```{r}
ps_phyto_DNA <- ps_TS %>%
  subset_taxa(rownames(ps_TS@tax_table) %in% taxa_DNA$asv_code)

phyto_otus <- data.frame(otu_table(ps_phyto_DNA))
write.csv(phyto_otus, "../supplementary_tables/photosynthetic_ASVs_OTUtable.csv")

#calculating ASV reads in ice and water
sum_ice_reads <- long_phyto_ice %>%
  group_by(asv_code) %>%
  summarize(sum_ice_reads=sum(n_reads))
sum_water_reads <- long_phyto_water %>%
  group_by(asv_code) %>%
  summarize(sum_water_reads=sum(n_reads))

phyto_taxa <- data.frame(tax_table(ps_phyto_DNA)) %>%
  rownames_to_column("asv_code")
phyto_taxa <- phyto_taxa %>%
  left_join(sum_ice_reads, by="asv_code") %>%
  mutate(sum_ice_reads = coalesce(sum_ice_reads, 0)) %>%
  left_join(sum_water_reads, by="asv_code") %>%
  mutate(sum_water_reads = coalesce(sum_water_reads, 0)) %>%
  mutate(sum_reads = sum_ice_reads + sum_water_reads) %>%
  arrange(desc(sum_reads)) 

write.csv(phyto_taxa, "../supplementary_tables/photosynthetic_ASVs_TAXONtable.csv")

phyto_samples <- data.frame(sample_data(ps_phyto_DNA))
write.csv(phyto_samples, "../supplementary_tables/photosynthetic_ASVs_SAMPLEtable.csv")

# add biogeo to ASVs
biogeo <- read.csv("../R_ice_camp/biogeoraphy_assignment_metaPR2/biogeo_casv.csv") %>% 
  select(-X)
phyto_biogeo <- left_join(phyto_taxa %>% select(asv_code, casv_code), biogeo, by="casv_code") %>%
  na.omit()
write.csv(phyto_biogeo, "../supplementary_tables/photosynthetic_ASVs_BIOGEOtable.csv")
```

# Table for SEM data comparison
```{r}
total_ice_phyto_reads <- sum(long_phyto_ice$n_reads)

DNA_ice_SEM <- long_phyto_ice %>% 
  mutate(across(domain_boot:species_boot,as.numeric)) %>%
  filter(class %in% c("Bacillariophyceae","Mediophyceae"), genus_boot>=80) %>%
  group_by(genus,species,asv_code) %>% 
  summarise(n_reads=sum(n_reads)) %>% 
  group_by(genus,species) %>% 
  summarise(n_reads=sum(n_reads), Nasv=n()) %>%
  mutate(pct_reads = (n_reads/total_ice_phyto_reads)*100)

xtable(DNA_ice_SEM)

total_water_phyto_reads <- sum(long_phyto_water$n_reads)

DNA_water_SEM <- long_phyto_water %>% 
  mutate(across(domain_boot:species_boot,as.numeric)) %>%
  filter(class %in% c("Bacillariophyceae","Mediophyceae"), genus_boot>=80) %>%
  group_by(genus,species,asv_code) %>% 
  summarise(n_reads=sum(n_reads)) %>% 
  group_by(genus,species) %>% 
  summarise(n_reads=sum(n_reads), Nasv=n()) %>%
  mutate(pct_reads = (n_reads/total_water_phyto_reads)*100) %>%
  select(-n_reads)

xtable(DNA_water_SEM)

```

# Plotting individual species and their ASVs and their map on metaPR2

```{r fig.height=5, fig.width=5}

microdiversity_asvs <- c("Baffinella_frigidus",
                            "Thalassiosira_nordenskioeldii",
                            "Navicula_sp.")

mapPalette<-c("#0072B2","#E69F00","#555555")
names(mapPalette)<-c("Polar","Polar-Temperate","Unallocated")

# import world map
world <- map_data("world")
#distribution of samples from metaPR2
long_meta <- read.csv("./biogeoraphy_assignment_metaPR2/metapr2_long.csv.gz")

for(i in microdiversity_asvs) {
species <- long %>% 
  filter(species==i) %>%
  filter(asv_code %in% indic_substrate_top$asv_code | asv_code %in% indic_bloom_cluster_top$asv_code) %>%
  group_by(asv_code,date,substrate,biogeo) %>%
  summarize(n_reads=sum(n_reads)) %>%
  mutate(asv_code=str_c(biogeo,"\n(",asv_code,")")) %>% 
  filter(n_reads!=0)

species_order <- species %>%
  group_by(asv_code,biogeo) %>%
  summarize(n_reads=sum(n_reads)) %>%
  arrange(desc(biogeo)) #Plots polar-temperate first, so polar points appear on top overlapping

species$asv_code <- factor(species$asv_code, levels=species_order$asv_code)

plot_time <-  ggplot(species, aes(x=date, y=n_reads)) +
  geom_bar(position="stack",stat="identity", color="black",aes(fill=biogeo)) +
  theme_bw() +
  scale_fill_manual(values=mapPalette, labels=rev(species_order$asv_code)) +
        theme(text=element_text(size=20),
              axis.text.x = element_text(angle = 45, hjust = 1), 
              axis.title.x = element_blank(),            
              legend.justification = "right", 
              legend.text = element_text(margin = margin(r=1.5,unit="cm")),
              legend.key.size=unit(2,"line"), 
              legend.position="bottom",
              legend.title = element_blank(),
              panel.spacing.x=unit(2, "lines"),
              panel.spacing.y=unit(1, "lines"), 
              panel.grid = element_blank(),
              strip.background=element_blank()) + 
        ggtitle(str_c(i," ASVs"))  +  
  ylab("No. of reads") +
  facet_grid(rows=vars(substrate),scales="free_x") 

plot_time


species <- long %>% 
  filter(species==i) %>%
  group_by(asv_code,casv_code,biogeo) %>%
  summarize(n_reads=sum(n_reads)) %>%
  select(asv_code,casv_code,biogeo)

list<-species$casv_code

species_distribution <- long_meta %>% 
  filter(casv_code %in% list) %>%
  left_join(species,by="casv_code") %>%
  mutate(asv_code=str_c(asv_code,"\n(",biogeo,")")) %>%
  arrange(desc(biogeo)) #Plots polar-temperate first, so polar points appear on top overlapping

plot_map_ortho<-ggplot() +
  geom_map(data=world,
           map=world,
           aes(long,lat,map_id=region),
            color="grey80", fill="#F2F2F2") +
  scale_x_continuous(breaks = seq(-180, 180, by = 10)) +
  scale_y_continuous(breaks= seq(0,90, by=10)) +
  geom_hline(yintercept=66, color="#0072B2", linetype="dashed") +
  geom_hline(yintercept=23, color="#D55E00", linetype="dashed") +
  geom_point(data=species_distribution,
             mapping=aes(x=longitude,y=latitude,color=biogeo),
             show.legend = FALSE,size=3,alpha=0.7) +
  scale_color_manual(values=mapPalette) +
  coord_map("ortho", ylim=c(30,90)) +
  theme(axis.text=element_blank(), #remove axis labels
        axis.ticks=element_blank(), #remove axis ticks
        axis.title=element_blank(), # remove axis title
        panel.border = element_rect(color="black", fill=NA, size=0.5),
        panel.background = element_rect(fill="#cdebf9"),
        panel.grid=element_line(size=0.4)) # long and lat line size
plot_map_ortho

plot_map_world<-ggplot() +
  geom_map(data=world,
           map=world,
           aes(long,lat,map_id=region),
            color="grey80", fill="#F2F2F2") +
  geom_hline(yintercept=66, color="#0072B2", linetype="dashed") +
  geom_hline(yintercept=23, color="#D55E00", linetype="dashed") +
  geom_hline(yintercept=-66, color="#0072B2", linetype="dashed") +
  geom_hline(yintercept=-23, color="#D55E00", linetype="dashed") +
  geom_point(data=species_distribution,
             mapping=aes(x=longitude,y=latitude,color=biogeo),
             show.legend = FALSE,size=3,alpha=0.7) +
  scale_color_manual(values=mapPalette) +
  theme(axis.text=element_blank(), #remove axis labels
        axis.ticks=element_blank(), #remove axis ticks
        axis.title=element_blank(), # remove axis title
        panel.border = element_rect(color="black", fill=NA, size=0.5),
        panel.background = element_rect(fill="#cdebf9"),
        panel.grid=element_line(size=0)) # long and lat line size
plot_map_world

pdf(str_c("../main_figures/ASV_",i,".pdf"), height=8, width=24) ; plot(plot_time+plot_map_ortho+plot_map_world); dev.off() 
}

```
